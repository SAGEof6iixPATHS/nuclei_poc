id: CVE-2024-6387

info:
  name: OpenSSH regreSSHion (CVE-2024-6387)
  author: x1will
  severity: high
  description: >
    Detects vulnerable OpenSSH *portable* builds (8.5p1 – 9.7p1, inclusive),
    even when the banner omits “p1”, while excluding vendor builds that
    back-ported the fix (Ubuntu, Debian, FreeBSD, Alpine). Fedora/RHEL banners
    don’t expose RPM release numbers, so any Fedora hit *must* be triaged
    manually with “rpm -q openssh-server”.
  classification:
    cve-id: CVE-2024-6387
  metadata:
    max-request: 2
    vendor: OpenSSH
    product: OpenSSH
  tags: cve,cve2024,regresshion,openssh,ssh

tcp:
  - host:
      - '{{Hostname}}'
      - '{{Host}}:22'

    inputs:
      - data: "SSH-2.0-OpenSSH_9.0\r\n"

    matchers-condition: and

    matchers:
      # 1️⃣ Upstream-portable vulnerable range: 8.5p1–9.7p1 (with OR without “p1”)
      - type: regex
        name: vulnerable-range
        part: body
        regex:
          - 'OpenSSH_(8\.[5-9](?:p1)?|9\.[0-7](?:p1)?)'

      # 2️⃣ Ubuntu patched builds (Jammy → Noble)
      - type: regex
        name: ubuntu-fixed
        part: body
        negative: true
        regex:
          - 'OpenSSH_8\.9p1 Ubuntu-3ubuntu0\.(1[0-9]|[2-9][0-9]+)'
          - 'OpenSSH_9\.3p1 Ubuntu-(?:1|3)ubuntu3\.(6|[7-9]|[1-9][0-9]+)'
          - 'OpenSSH_9\.6p1 Ubuntu-3ubuntu13\.(3|[4-9]|[1-9][0-9]+)'

      # 3️⃣ Debian patched builds (bookworm & unstable)
      - type: regex
        name: debian-fixed
        part: body
        negative: true
        regex:
          - 'OpenSSH_9\.2p1 Debian-2\+deb12u[3-9][0-9]*'
          - 'OpenSSH_8\.4p1 Debian-5\+deb11u[3-9][0-9]*'
          - 'OpenSSH_9\.7p1 Debian-[7-9][0-9]*'

      # 4️⃣ FreeBSD patched snapshots (timestamp ≥ 20240701)
      - type: regex
        name: freebsd-fixed
        part: body
        negative: true
        regex:
          - 'OpenSSH_9\.[67](?:p1)? FreeBSD-2024[0-9]{4}'
          - 'OpenSSH_9\.[67](?:p1)? FreeBSD-2025[0-9]{4}'

      # 5️⃣ Alpine patched packages
      - type: regex
        name: alpine-fixed
        part: body
        negative: true
        regex:
          - 'OpenSSH_9\.7_p?1-r4'
          - 'OpenSSH_9\.6_p?1-r1'
          - 'OpenSSH_9\.3_p?2-r2'
          - 'OpenSSH_9\.1_p?1-r6'
